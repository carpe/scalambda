<!DOCTYPE html><html><head><title>scalambda: Using Graal Native</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Carpe Data" /><meta name="description" content="Toolkit for building/deploying Lambda Functions with SBT" /><meta name="og:image" content="/scalambda/img/poster.png" /><meta name="image" property="og:image" content="/scalambda/img/poster.png" /><meta name="og:title" content="scalambda: Using Graal Native" /><meta name="title" property="og:title" content="scalambda: Using Graal Native" /><meta name="og:site_name" content="scalambda" /><meta name="og:url" content="https://carpe.github.io/scalambda/" /><meta name="og:type" content="website" /><meta name="og:description" content="Toolkit for building/deploying Lambda Functions with SBT" /><link rel="icon" type="image/png" href="/scalambda/img/favicon.png" /><meta name="twitter:title" content="scalambda: Using Graal Native" /><meta name="twitter:image" content="/scalambda/img/poster.png" /><meta name="twitter:description" content="Toolkit for building/deploying Lambda Functions with SBT" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/scalambda/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/scalambda/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/scalambda/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/scalambda/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/scalambda/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/scalambda/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/scalambda/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/scalambda/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/scalambda/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/scalambda/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/scalambda/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/scalambda/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/scalambda/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/scalambda/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/scalambda/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/scalambda/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/scalambda/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/scalambda/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/scalambda/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/scalambda/img/favicon310x150.png" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/scalambda/highlight/styles/vs.css" /><link rel="stylesheet" href="/scalambda/css/light-style.css" /><script async="async">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-85042842-3' , 'auto');
ga('send', 'pageview');
      </script></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><div id="sidebar-brand"><a href="/scalambda/" class="brand"><div class="brand-wrapper"></div><span>scalambda</span></a><button id="main-toggle" class="sidebar-toggle"><span class="close"></span></button></div><div class="sidebar-nav"> <div class="sidebar-nav-item  "><a href="/scalambda/docs/" title="Getting Started" class="">Getting Started</a></div> <div class="sidebar-nav-item  "><a href="/scalambda/docs/configuration" title="Configuring Functions" class="">Configuring Functions</a></div> <div class="sidebar-nav-item  "><a href="/scalambda/docs/writing-functions" title="Writing Functions" class="">Writing Functions</a></div> <div class="sidebar-nav-item  "><a href="/scalambda/docs/deploying-functions" title="Deploying Functions" class="">Deploying Functions</a></div> <div class="sidebar-nav-item  "><button type="button" title="Api Gateway" class="button drop-nested">Api Gateway</button><i class="fa fa-angle-right"></i><div class="sub-section"> <a href="/scalambda/docs/api/create-api" title="Create an API" class="">Create an API</a> <a href="/scalambda/docs/api/deploy-api" title="Deploy an API" class="">Deploy an API</a></div></div> <div class="sidebar-nav-item active "><a href="/scalambda/docs/thegraaaaal/" title="Using Graal Native" class="active">Using Graal Native</a></div></div></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li class="search-nav"><div id="search-dropdown"><label><i class="fa fa-search"></i>Search</label><input id="search-bar" type="text" placeholder="Enter keywords here..." onclick="displayToggleSearch(event)" /><ul id="search-dropdown-content" class="dropdown dropdown-content"></ul></div></li><li id="gh-eyes-item" class="hidden-xs to-uppercase"><a href="https://github.com/carpe/scalambda" target="_blank" rel="noopener noreferrer"><i class="fa fa-eye"></i><span>Watchers<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs to-uppercase"><a href="https://github.com/carpe/scalambda" target="_blank" rel="noopener noreferrer"><i class="fa fa-star-o"></i><span>Stars<span id="stars" class="label label-default">--</span></span></a></li></ul></div></div></div></div><div id="content" data-github-owner="carpe" data-github-repo="scalambda"><div class="content-wrapper"><section><h2 id="what-and-why">What and why?</h2>

<p>If you’re not yet familiar with GraalVM’s <a href="https://www.graalvm.org/reference-manual/native-image/">Native Image builder</a>, it essentially allows you to turn your Java code into a native executable. This essentially allows you to <strong>run your code without a JVM</strong>, which allows for nearly instantaneous start times. It also allows for some pretty awesome optimizations like the ability to <strong>initialize certain objects at compile time</strong>. Both of these advantages by themselves are incredibly powerful tools that can allow you to <strong>decimate your function’s cold start times</strong>.</p>

<h4 id="disclaimers">Disclaimers</h4>

<p>GraalVM’s Native Image builder isn’t quite magic, and comes with some serious risks. The good news is, the problems with Graal Native tend to come up at compile time, rather than during your function’s runtime. However, debugging/fixing these build issues with your native images can be incredibly costly. One of my favorite posts that I think perfectly demonstrates just how time-consuming and intensive debugging these issues can be is <a href="https://medium.com/graalvm/instant-netty-startup-using-graalvm-native-image-generation-ed6f14ff7692">this post</a>, which talks about getting Netty to work with Graal Native.</p>

<p>Imagine the amount of time that went into figuring out the issues that post talks about. Spoiler alert: it takes a ton of time. If your function is incredibly simple with few dependencies, then you might be able to get away with turning your function into a Native Image. Otherwise, try to look at <a href="https://www.reddit.com/r/scala/comments/hw6iic/sbt_plugin_for_quick_and_easy_aws_lambda_function/fz08cje?utm_source=share&amp;utm_medium=web2x&amp;context=3">other ways of reducing your cold start times</a>.</p>

<p><strong>TL;DR:</strong> Don’t use Graal Native if you aren’t prepared to invest huge amounts of time debugging a ton of build issues. If you have a dedicated team at your company that solves these kinds of issues, be prepared for everyone on that team to start hating you and don’t expect them to be able to get your function to actually work.</p>

<p>All that being said, you can always revert to the <code class="language-plaintext highlighter-rouge">Java11</code> or <code class="language-plaintext highlighter-rouge">Java8</code> runtime if you can’t get your function to work in <code class="language-plaintext highlighter-rouge">GraalNative</code> mode. So if you’ve some time you want to kill, you can follow the guide below to give Graal Native a shot to see if it works with your function.</p>

<h2 id="configuration">Configuration</h2>

<p>One quick note before you start, I highly recommend that you try deploying a <code class="language-plaintext highlighter-rouge">Java8</code> or <code class="language-plaintext highlighter-rouge">Java11</code> with Scalambda first, before jumping into the deep end. <strong>You can do it in under 5 minutes</strong> using our <a href="https://github.com/carpe/scalambda.g8/">g8 template</a> and it will give you a perfect plan B if/when you run into issues with Graal Native.</p>

<h4 id="prerequisites">Prerequisites</h4>

<p>Scalambda uses <a href="https://sbt-native-packager.readthedocs.io/en/latest/">SBT Native Packager</a> under the hood. Before running <code class="language-plaintext highlighter-rouge">scalambdaTerraform</code>, you’ll need to make sure you have installed all of the <a href="https://sbt-native-packager.readthedocs.io/en/latest/formats/graalvm-native-image.html#requirements">requirements</a>.</p>

<h4 id="buildsbt">build.sbt</h4>

<p>Below is an example <code class="language-plaintext highlighter-rouge">build.sbt</code> file for a fully configured lambda function using a Native Image.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">lazy</span> <span class="k">val</span> <span class="nv">nativegreeter</span> <span class="k">=</span> <span class="o">(</span><span class="n">project</span> <span class="n">in</span> <span class="nf">file</span><span class="o">(</span><span class="s">"."</span><span class="o">))</span>
  <span class="o">.</span><span class="py">enablePlugins</span><span class="o">(</span><span class="nc">ScalambdaPlugin</span><span class="o">)</span>
  <span class="o">.</span><span class="py">settings</span><span class="o">(</span>
    <span class="c1">// this call enables Scalambda, and sets the class found at this path to be the handler</span>
    <span class="nf">scalambda</span><span class="o">(</span><span class="s">"science.doing.nativegreeter.NativeGreeter"</span><span class="o">,</span> <span class="n">runtime</span> <span class="k">=</span> <span class="nc">GraalNative</span><span class="o">,</span> <span class="n">memory</span> <span class="k">=</span> <span class="mi">256</span><span class="o">)</span>
  <span class="o">).</span><span class="py">settings</span><span class="o">(</span>
    <span class="c1">// graal native image settings</span>
    <span class="c1">// Options used by `native-image` when building native image</span>
    <span class="c1">// https://www.graalvm.org/docs/reference-manual/native-image/</span>
    <span class="n">graalVMNativeImageOptions</span> <span class="o">++=</span> <span class="nc">Seq</span><span class="o">(</span>
      <span class="s">"--initialize-at-build-time"</span><span class="o">,</span> <span class="c1">// Auto-packs dependent libs at build-time</span>
      <span class="s">"--no-fallback"</span><span class="o">,</span> <span class="c1">// Bakes-in run-time reflection (alternately: --auto-fallback, --force-fallback)</span>
      <span class="s">"--no-server"</span><span class="o">,</span> <span class="c1">// Won't be running `graalvm-native-image:packageBin` often, so one less thing to break</span>
      <span class="s">"--static"</span><span class="o">,</span> <span class="c1">// Forces statically-linked binary, requires libc installation. Comment this out if you're using OSX</span>
      <span class="s">"--enable-url-protocols=http"</span> <span class="c1">// Enables http requests, which are required in order to communicate with the AWS Lambda Runtime API</span>
      <span class="c1">// "--enable-url-protocols=http,https" // Enables both http and https requests</span>
    <span class="o">)</span>
  <span class="o">)</span>
</code></pre></div></div>

<p>You will almost certainly need to tweak the configuration a bit depending on the needs for your function. You will almost certainly need to tweak the settings above in order for your code to successfully build. Checkout the <a href="https://sbt-native-packager.readthedocs.io/en/latest/formats/graalvm-native-image.html#settings">full list of available settings</a> in sbt-native-packager’s documentation.</p>

<p><strong>Important Note:</strong> Due to current limitations on how we assemble your native image, <strong>each sub-project can only include one <code class="language-plaintext highlighter-rouge">GraalNative</code> Scalambda Function</strong>.</p>

<h2 id="implementation">Implementation</h2>

<p>In order to get your function to execute properly, <strong>you only need to do two things</strong>.</p>

<ol>
  <li>Your main class must be an <code class="language-plaintext highlighter-rouge">object</code>.</li>
  <li>Your main class must extend either <code class="language-plaintext highlighter-rouge">io.carpe.scalambda.native.ScalambdaIO</code> or <code class="language-plaintext highlighter-rouge">io.carpe.scalambda.native.Scalambda</code>.</li>
</ol>

<p>Scalambda automatically injects the library that includes the <code class="language-plaintext highlighter-rouge">io.carpe.scalambda.native</code> package when you set your function’s runtime to <code class="language-plaintext highlighter-rouge">GraalNative</code>.</p>

<p>Other than these two things, you shouldn’t need to change anything else at all from the usual code you’d use for a JVM-based Scalambda Function. Of course, you may want to tweak things later.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="nn">science.doing.nativegreeter</span>

<span class="k">import</span> <span class="nn">cats.effect.IO</span>
<span class="k">import</span> <span class="nn">io.carpe.scalambda.native.ScalambdaIO</span>

<span class="c1">// NOTE: we are using the `native` ScalambdaIO, not the JVM based one.</span>
<span class="k">object</span> <span class="nc">NativeGreeter</span> <span class="k">extends</span> <span class="nc">ScalambdaIO</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">String</span><span class="o">]</span> <span class="o">{</span>

  <span class="k">override</span> <span class="k">def</span> <span class="nf">run</span><span class="o">(</span><span class="n">input</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">IO</span> <span class="o">{</span>
    <span class="s">"Hello, "</span> <span class="o">+</span> <span class="n">input</span> <span class="o">+</span> <span class="s">"!"</span>
  <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<h2 id="building-and-deploying">Building and Deploying</h2>

<p>Assuming you already have the prerequisites installed, you can try to deploy your new Graal Native Lambda function the same way as any other Scalambda Lambda Function. Just run <code class="language-plaintext highlighter-rouge">sbt scalambdaTerraform</code> to generate the terraform and then apply it. For further details, checkout <a href="https://carpe.github.io/scalambda/docs/deploying-functions/">Deploying Functions</a> for a more in-depth explanation.</p>
</section></div></div></div></div><script src="/scalambda/highlight/highlight.pack.js"></script><script src="/scalambda/lunr/lunr.js"></script><script>
// For all code blocks, copy the language from the containing div
// to the inner code tag (where hljs expects it to be)
const langPrefix = 'language-';
document.querySelectorAll(`div[class^='${langPrefix}']`).forEach(function(div) {
  div.classList.forEach(function(cssClass) {
    if (cssClass.startsWith(langPrefix)) {
      const lang = cssClass.substring(langPrefix.length);
      div.querySelectorAll('pre code').forEach(function(code) {
        code.classList.add(lang);
      });
    }
  });
});

hljs.configure({languages:['scala','java','bash']});
hljs.initHighlightingOnLoad();
      </script><script>console.info('\x57\x65\x62\x73\x69\x74\x65\x20\x62\x75\x69\x6c\x74\x20\x77\x69\x74\x68\x3a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x5f\x5f\x0a\x20\x20\x20\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x5f\x20\x20\x2f\x20\x2f\x5f\x20\x20\x20\x20\x20\x20\x5f\x5f\x5f\x5f\x20\x5f\x5f\x5f\x20\x20\x28\x5f\x29\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x28\x5f\x29\x20\x2f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x0a\x20\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x60\x5f\x5f\x20\x5c\x2f\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x20\x2f\x20\x5f\x5f\x2f\x20\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x0a\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x5f\x2f\x20\x2f\x20\x2f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x5f\x5f\x2f\x20\x2f\x20\x20\x2f\x20\x2f\x5f\x2f\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x20\x2f\x5f\x2f\x20\x20\x5f\x5f\x28\x5f\x5f\x20\x20\x29\x0a\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2e\x5f\x5f\x5f\x2f\x5c\x5f\x5f\x2f\x20\x20\x20\x20\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x2f\x20\x20\x20\x5c\x5f\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x0a\x0a\x68\x74\x74\x70\x73\x3a\x2f\x2f\x34\x37\x64\x65\x67\x2e\x67\x69\x74\x68\x75\x62\x2e\x69\x6f\x2f\x73\x62\x74\x2d\x6d\x69\x63\x72\x6f\x73\x69\x74\x65\x73')</script><script src="/scalambda/js/search.js"></script><script src="/scalambda/js/docs.js"></script></body></html>